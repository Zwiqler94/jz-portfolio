name: Workflow Orchestrator
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-orchestrator
  cancel-in-progress: true
on:
  pull_request_target:
    types:
      - closed
      - synchronize
jobs:
  analyze-code:
    uses: ./.github/workflows/codeql-analysis2.yml
  deploy-dev-pr-preview:
    needs: ["analyze-code"]
    if: ${{ github.event.action == 'synchronize'  && github.base_ref == 'development' }}
    uses: ./.github/workflows/firebase-hosting-pull-request-development.yml
  deploy-prod-pr-preview:
    needs: ["analyze-code"]
    if: ${{ github.event.action == 'synchronize' && github.base_ref == 'main' }}
    uses: ./.github/workflows/firebase-hosting-pull-request.yml
  deploy-dev:
    needs: ["analyze-code"]
    if: ${{ github.event.action == 'closed'  && github.base_ref == 'development'}}
    uses: ./.github/workflows/firebase-hosting-merge-development.yml
  deploy-prod:
    needs: ["analyze-code"]
    if: ${{ github.event.action == 'closed' && github.base_ref == 'main' }}
    uses: ./.github/workflows/firebase-hosting-merge.yml
  check-deploy-job:
    runs-on: ubuntu-latest
    needs:
      [
        "deploy-dev-pr-preview",
        "deploy-prod-pr-preview",
        "deploy-dev",
        "deploy-prod",
      ]
    if: ${{ always() }}
    steps:
      - run: |
          if [[ '${{ needs.deploy-dev-pr-preview.result }}' == 'failure' && '${{ needs.deploy-prod-pr-preview.result }}' == 'failure' && '${{ needs.deploy-dev.result }}' == 'failure' && '${{ needs.deploy-prod.result }}' == 'failure' ]]; then
             echo "Deploy Failed"
             exit 1
          elif [[ '${{ needs.deploy-dev-pr-preview.result }}' == 'success' || '${{ needs.deploy-prod-pr-preview.result }}' == 'success' || '${{ needs.deploy-dev.result }}' == 'success' || '${{ needs.deploy-prod.result }}' == 'success' ]]; then
             exit 0
          else
            exit 1
          fi
  version:
    needs: ["analyze-code", "check-deploy-job"]
    if: ${{github.event.action == 'closed' }}
    uses: ./.github/workflows/version-on-merge.yml
